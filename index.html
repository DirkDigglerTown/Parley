<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parley Protocol — Multi‑Agent LLM Debates on Solana Vibes</title>
  <meta name="description" content="A sleek, futuristic demo where multiple local LLMs debate deep questions in your browser via WebGPU (WebLLM)." />
  <link rel="preconnect" href="https://esm.run" />
  <style>
    :root{
      --bg:#05070c; --fg:#e6f1ff; --muted:#9bb0c8; --glass:rgba(255,255,255,.06);
      --accent:#00e5ff; --accent2:#7c4dff; --good:#00e27b; --warn:#ffd166; --bad:#ff5c8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 80% -10%, #0a1b27 0%, transparent 60%),
                  radial-gradient(1000px 500px at -10% 0%, #0f0a2b 0%, transparent 60%),
                  linear-gradient(180deg, #04060a 0%, #02040a 60%, #020208 100%);
      color:var(--fg);
      overflow-x:hidden;
    }
    .grid{
      display:grid; grid-template-columns:minmax(0,1fr);
      gap:24px; width:min(1200px, 92vw); margin:0 auto; padding:24px 0 72px;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(10,14,20,.85), rgba(10,14,20,.45));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 0}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:36px; height:36px; border-radius:10px; background:
        conic-gradient(from 120deg at 50% 50%, var(--accent), var(--accent2), var(--accent));
      box-shadow:0 0 30px rgba(0,229,255,.4), inset 0 0 24px rgba(124,77,255,.25);
    }
    .brand h1{font-size:18px; letter-spacing:.4px; margin:0; font-weight:700}
    .badge{font-size:12px; color:var(--muted); opacity:.9}

    .hero{position:relative; padding:48px 0 16px}
    .hero h2{font-weight:800; line-height:1.05; margin:0 0 10px; font-size: clamp(28px, 4.5vw, 56px)}
    .hero p{margin:0; color:var(--muted); font-size: clamp(14px, 2vw, 18px)}

    .glass{background:var(--glass); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:16px; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset, 0 10px 30px rgba(0,0,0,.35)}
    .controls{display:grid; grid-template-columns:1fr; gap:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    select, textarea, input[type="text"], button{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(10,14,22,.65); color:var(--fg); font-family:inherit}
    textarea{min-height:92px; resize:vertical}
    button{cursor:pointer; border-color:transparent; background:linear-gradient(90deg, var(--accent), var(--accent2)); font-weight:700}
    button:disabled{opacity:.5; cursor:not-allowed}

    .agents{display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:12px}
    .agent{padding:12px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1)}
    .agent h4{margin:0 0 6px; font-size:14px}
    .agent small{color:var(--muted)}

    .chat{display:grid; gap:10px; max-height:52vh; overflow:auto; padding-right:4px}
    .bubble{padding:12px 14px; border-radius:12px; line-height:1.45; border:1px solid rgba(255,255,255,.1); background:rgba(6,10,16,.6)}
    .bubble.agentA{border-left:3px solid var(--accent)}
    .bubble.agentB{border-left:3px solid var(--good)}
    .bubble.agentC{border-left:3px solid var(--bad)}
    .sys{font-size:12px; color:var(--muted)}
    .footer{opacity:.8; font-size:12px; color:var(--muted)}

    .meter{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .meter>i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}

    .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,.1); border-radius:999px; background:rgba(255,255,255,.04); font-size:12px; color:var(--muted)}
    .tags{display:flex; gap:8px; flex-wrap:wrap}

    .credit{display:flex; align-items:center; gap:8px; color:var(--muted)}
    a{color:var(--accent)}

    /* Subtle animated grid lines */
    .gridlines:before, .gridlines:after{
      content:""; position:fixed; inset:0; pointer-events:none; background:
      repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 160px),
      repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 160px);
      mask-image:radial-gradient(800px 800px at 80% 0%, rgba(255,255,255,.9) 0%, transparent 60%);
      animation: drift 22s linear infinite; z-index:0;
    }
    @keyframes drift{0%{transform:translateY(0)}100%{transform:translateY(30px)}}

    .tiny{font-size:11px}
    .hide{display:none}
      /* Media backgrounds */
    .hero{position:relative; overflow:hidden}
    .hero-bg{position:absolute; inset:-10% -10% -20% -10%; z-index:0; opacity:.35}
    .hero-bg video, .hero-bg img{width:100%; height:100%; object-fit:cover; filter:contrast(1.08) saturate(1.08) brightness(.9)}
    
    .art img{width:100%; display:block; border-radius:12px}

    .chat-wrap{position:relative; overflow:hidden}
    .chat-bg{position:absolute; inset:0; z-index:0; opacity:.28; filter:blur(1px) saturate(1.05)}
    .chat{position:relative; z-index:1; background:linear-gradient(180deg, rgba(3,6,12,.75), rgba(3,6,12,.55));}
</style>
</head>
<body>
  <div class="grid gridlines">
    <header>
      <div class="grid nav">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Parley Protocol</h1>
            <div class="badge">Multi‑Agent LLM Debates — runs 100% in your browser</div>
          </div>
        </div>
        <div class="credit tiny">Powered by <a href="https://webllm.mlc.ai/" target="_blank" rel="noopener">WebLLM (WebGPU)</a></div>
      </div>
    </header>

    <section class="hero grid">
      <div class="hero-bg">
        <video src="Intro sting.mp4" poster="Solana-coded UI background.png" autoplay muted playsinline loop></video>
      </div>
      <div class="glass">
        <h2>Watch AIs argue (politely) about hard problems.</h2>
        <p>Pose a deep, world‑scale question. Then pick 2–3 expert personas and let them debate toward a synthesis — privately on your device.</p>
      </div>

      <div class="controls glass">
        <div class="row">
          <div style="flex:2 1 420px">
            <label>Big Question</label>
            <textarea id="question" placeholder="e.g., How do we reduce the risk of great‑power conflict while safeguarding smaller nations' sovereignty?"></textarea>
          </div>
          <div style="flex:1 1 220px">
            <label>Model (browser‑local)</label>
            <select id="model">
              <option value="Llama-3.1-8B-Instruct-q4f32_1-MLC">Llama‑3.1‑8B‑Instruct (bigger, slower)</option>
              <option value="Qwen2-1.5B-Instruct-q4f32_1-MLC">Qwen2‑1.5B‑Instruct (lightweight)</option>
              <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi‑3‑Mini‑4k‑Instruct (lightweight)</option>
            </select>
            <div class="tiny" id="gpuNote">Your first load will download model weights (~hundreds of MB). Cached for next time.</div>
          </div>
        </div>

        <div class="glass art"><img src="Agent archetypes panel.png" alt="AI agent archetypes: Strategist, Diplomat, Technocrat" loading="lazy"></div>
        <div class="agents">
          <div class="agent">
            <h4>Agent A — Realist Strategist</h4>
            <small>Prioritizes stability, deterrence, power dynamics.</small>
            <textarea id="a" class="sys" placeholder="System prompt for Agent A">You are a Realist Strategist. You value state stability, deterrence, multipolar balance, incrementalism, and credible commitments. Avoid moralizing; emphasize tradeoffs and verification.</textarea>
          </div>
          <div class="agent">
            <h4>Agent B — Humanitarian Diplomat</h4>
            <small>Emphasizes human rights, institutions, win‑wins.</small>
            <textarea id="b" class="sys" placeholder="System prompt for Agent B">You are a Humanitarian Diplomat. You prioritize human rights, humanitarian corridors, international law, confidence‑building measures, and inclusive governance. Seek constructive‑sum policies.</textarea>
          </div>
          <div class="agent">
            <h4>Agent C — Data‑Driven Technocrat (optional)</h4>
            <small>Evidence‑based, mechanism design, incentives.</small>
            <textarea id="c" class="sys" placeholder="System prompt for Agent C">You are a Data‑Driven Technocrat. You lean on causal evidence, mechanism design, incentive alignment, and measurable KPIs. You translate ideals into testable policy pilots.</textarea>
          </div>
        </div>

        <div class="row">
          <div style="flex:1 1 160px">
            <label>Turns per agent</label>
            <input id="turns" type="text" value="2" />
          </div>
          <div style="flex:2 1 320px">
            <label>Debate Goal / Instructions</label>
            <input id="goal" type="text" value="Debate constructively and end with a short, concrete joint plan with 3 actionable steps and named risks." />
          </div>
          <div style="flex:1 1 160px; align-self:end; display:flex; gap:10px; width:100%">
            <button id="loadBtn">Load Model</button>
            <button id="runBtn" disabled>Run Parley</button>
          </div>
        </div>

        <div class="meter"><i id="meterBar"></i></div>
        <div class="tiny" id="status">Status: idle</div>
      </div>

      <div class="glass">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div class="tags">
            <span class="pill">No server • No API keys</span>
            <span class="pill">WebGPU accelerated</span>
            <span class="pill">OpenAI‑style API</span>
          </div>
          <div class="tiny">Tip: keep the third agent if your machine is beefy; otherwise uncheck Agent C content to leave it empty.</div>
        </div>
      </div>

      <div class="glass chat-wrap">
        <div class="chat-bg">
          <video src="Background loop for chat area.mp4" poster="Neon debate chamber.png" autoplay muted playsinline loop></video>
        </div>
        <div class="chat" id="chat"></div>
      </div>

      <div class="footer">© 2025 Parley Protocol — for fun, memes, and thoughtful policy tinkering.</div>
    </section>
  </div>

  <script type="module">
    const statusEl = document.getElementById('status');
    const meterBar = document.getElementById('meterBar');
    const runBtn = document.getElementById('runBtn');
    const loadBtn = document.getElementById('loadBtn');
    const chatEl = document.getElementById('chat');

    const questionEl = document.getElementById('question');
    const turnsEl = document.getElementById('turns');
    const goalEl = document.getElementById('goal');
    const modelEl = document.getElementById('model');
    const aEl = document.getElementById('a');
    const bEl = document.getElementById('b');
    const cEl = document.getElementById('c');

    let engine = null;

    function logBubble(role, text){
      const div = document.createElement('div');
      const cls = role === 'A' ? 'agentA' : role === 'B' ? 'agentB' : role === 'C' ? 'agentC' : '';
      div.className = `bubble ${cls}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setStatus(msg){ statusEl.textContent = msg; }
    function setProgress(p){ meterBar.style.width = `${Math.max(2, Math.floor(p*100))}%`; }

    async function loadModel(){
      setStatus('Importing WebLLM…');
      setProgress(0.05);
      loadBtn.disabled = true;
      try{
        const webllm = await import('https://esm.run/@mlc-ai/web-llm');
        const selectedModel = modelEl.value;
        setStatus(`Loading model: ${selectedModel}`);
        engine = await webllm.CreateMLCEngine(selectedModel, {
          initProgressCallback: (p)=>{
            const frac = p.progress || 0; // p has {progress, text}
            setProgress(frac);
            setStatus(`Loading: ${Math.round(frac*100)}% — ${p.text||''}`);
          }
        });
        runBtn.disabled = false;
        setStatus('Model ready. Ask a question and press Run Parley.');
        setProgress(1);
      }catch(err){
        console.error(err);
        setStatus('Failed to load WebLLM. Ensure WebGPU is enabled (Chrome/Edge ≥ 113, recent Safari/Firefox).');
        loadBtn.disabled = false;
      }
    }

    async function generate(messages){
      const chunks = await engine.chat.completions.create({ messages, stream: true, temperature: 0.9 });
      let reply = '';
      for await (const ch of chunks){
        reply += ch.choices?.[0]?.delta?.content || '';
      }
      return reply.trim();
    }

    function buildPrompt(rolePrompt, userQ, debateGoal){
      return [
        { role:'system', content: rolePrompt + `\nFollow the debate goal exactly: ${debateGoal}` },
        { role:'user', content: `Question: ${userQ}\nRespond concisely in 5–8 sentences.`}
      ];
    }

    function rebuttalPrompt(rolePrompt, transcript, debateGoal){
      return [
        { role:'system', content: rolePrompt + `\nDebate goal: ${debateGoal}` },
        { role:'user', content: `Transcript so far:\n${transcript}\nWrite your next turn. Be specific. Cite mechanisms, risks, and a concrete proposal.` }
      ];
    }

    function synthesisPrompt(transcript, debateGoal){
      return [
        { role:'system', content: `You are the Moderator. Your job is to synthesize areas of agreement and tension into a clear, realistic joint plan.` },
        { role:'user', content: `Create a final outcome based on this debate:\n${transcript}\nOutput format:\n1) Joint Plan: three bullet points with concrete steps.\n2) Risks: two bullets with mitigations.\n3) Open Question: one unresolved issue.` }
      ];
    }

    async function runParley(){
      if(!engine) return alert('Load a model first.');
      chatEl.innerHTML = '';

      const q = questionEl.value.trim() || 'How can rival blocs deescalate tensions while protecting small states\' sovereignty and trade resilience?';
      const turns = Math.max(1, parseInt(turnsEl.value||'2',10));
      const goal = goalEl.value.trim();

      const personas = [];
      if(aEl.value.trim()) personas.push(['A', aEl.value.trim()]);
      if(bEl.value.trim()) personas.push(['B', bEl.value.trim()]);
      if(cEl.value.trim()) personas.push(['C', cEl.value.trim()]);
      if(personas.length < 2) return alert('Please keep at least two agents.');

      let transcript = '';

      setStatus('Generating opening statements…');
      for(const [tag, prompt] of personas){
        const msg = await generate(buildPrompt(prompt, q, goal));
        transcript += `\n\n[${tag}] ${msg}`;
        logBubble(tag, msg);
      }

      setStatus('Running debate…');
      for(let t=0; t<turns-1; t++){
        for(const [tag, prompt] of personas){
          const msg = await generate(rebuttalPrompt(prompt, transcript.slice(-4000), goal));
          transcript += `\n\n[${tag}] ${msg}`;
          logBubble(tag, msg);
        }
      }

      setStatus('Synthesizing…');
      const mod = await generate(synthesisPrompt(transcript.slice(-6000), goal));
      logBubble('Moderator', mod);
      setStatus('Done.');
    }

    loadBtn.addEventListener('click', loadModel);
    runBtn.addEventListener('click', runParley);

    // Safety: detect WebGPU
    if(!('gpu' in navigator)){
      document.getElementById('gpuNote').innerHTML = "Your browser doesn't report WebGPU. Try Chrome/Edge 113+, or enable chrome://flags/#enable-unsafe-webgpu";
    }
  </script>
</body>
</html>
