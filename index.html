<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parley Protocol — Multi-Agent LLM Debates</title>
  <meta name="description" content="Watch AI agents debate deep questions in your browser — no servers, no paid APIs. WebGPU + WebLLM." />
  <link rel="preconnect" href="https://esm.run" />
  <style>
    :root{
      --bg:#05070c; --fg:#e6f1ff; --muted:#9bb0c8; --glass:rgba(255,255,255,.06);
      --accent:#00e5ff; --accent2:#7c4dff; --good:#00e27b; --warn:#ffd166; --bad:#ff5c8a;
      --outline:rgba(255,255,255,.10); --ok:#00e27b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%}
    body{
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--fg);
      overflow-x:hidden;
      background-color:var(--bg);
      background-image:
        linear-gradient(180deg, rgba(4,6,12,.88), rgba(4,6,12,.70)),
        url("Solana-coded UI background.png");
      background-position:center center;
      background-size:cover;
      background-attachment:fixed;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(10,14,20,.92), rgba(10,14,20,.65));
      border-bottom:1px solid var(--outline);
    }
    .nav{width:min(1100px,92vw); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:28px; width:auto; filter:drop-shadow(0 2px 8px rgba(0,229,255,.15))}
    .brand h1{font-size:18px; font-weight:800; letter-spacing:.2px}
    .credit{font-size:12px; color:var(--muted)}
    .credit a{color:var(--accent)}
    main{position:relative; z-index:1; width:min(1100px,92vw); margin:0 auto; padding:20px 0 80px; display:grid; gap:18px}

    .wgpu-warning{display:none; background:rgba(255,92,138,0.12); border:1px solid var(--bad); color:var(--bad); padding:10px 12px; border-radius:10px; font-size:14px}

    .hero{position:relative; overflow:hidden; min-height:48vh; border-radius:18px; border:1px solid var(--outline)}
    .hero video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; pointer-events:none; filter:contrast(1.08) saturate(1.05) brightness(.9)}
    .hero-overlay{position:relative; z-index:2; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center; text-align:center; min-height:48vh; padding:22px; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25))}
    .hero-overlay h2{font-size:clamp(28px,4.2vw,48px); line-height:1.05}
    .hero-overlay p{color:var(--muted); max-width:720px}

    .glass{background:var(--glass); border:1px solid var(--outline); border-radius:18px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .stack{display:grid; gap:12px}

    .controlbar{
      display:grid; grid-template-columns: 1fr 220px 140px 220px; gap:10px; align-items:end;
    }
    @media (max-width:960px){ .controlbar{grid-template-columns:1fr 1fr; grid-auto-rows:auto} }
    label{font-size:12px; color:var(--muted)}
    textarea,select,input,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(10,14,22,.65); color:var(--fg)}
    textarea{min-height:64px; resize:vertical}
    button{cursor:pointer; background:linear-gradient(90deg, var(--accent), var(--accent2)); font-weight:700; border:none}
    .btn-secondary{background:rgba(255,255,255,.06); border:1px solid var(--outline)}

    .meter{height:8px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .meter>i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}
    .tiny{font-size:11px; color:var(--muted)}

    .chat-wrap{position:relative; overflow:hidden; border-radius:16px; border:1px solid var(--outline); background:rgba(4,8,14,.65)}
    .chat{position:relative; z-index:1; max-height:56vh; overflow:auto; padding:14px; display:grid; gap:8px}
    .bubble{padding:11px 12px; border-radius:12px; background:rgba(6,10,16,.6); border:1px solid rgba(255,255,255,.1); line-height:1.45}
    .agentA{border-left:3px solid var(--accent)}
    .agentB{border-left:3px solid var(--good)}
    .agentC{border-left:3px solid var(--bad)}

    .feed{display:grid; gap:10px}
    .feed-item{border:1px solid var(--outline); border-radius:14px; padding:12px; background:rgba(255,255,255,.04)}
    .feed-item h5{margin:0 0 6px 0; font-size:14px}
    .feed-item small{color:var(--muted)}
    .feed-tools{display:flex; gap:6px; align-items:center; justify-content:flex-end; margin-top:8px}
    .feed-details{display:none; margin-top:8px; padding-top:8px; border-top:1px dashed var(--outline); white-space:pre-wrap; font-size:13px; color:#d2def0}
    .feed-item.open .feed-details{display:block}

    .meet{display:grid; gap:12px}
    .meet img{width:100%; border-radius:12px; display:block}

    .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:rgba(6,10,16,.9); color:var(--fg); border:1px solid var(--outline); padding:10px 14px; border-radius:10px; font-size:13px; display:none}
    .toast.ok{border-color:var(--ok)}
    .toast.bad{border-color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <img src="ParleyLogo.png" alt="Parley Protocol logo" />
        <h1>Parley Protocol</h1>
      </div>
      <div class="credit">Powered by <a href="https://webllm.mlc.ai/" target="_blank" rel="noopener">WebLLM</a></div>
    </div>
  </header>

  <main>
    <div id="wgpuBanner" class="wgpu-warning">
      ⚠️ Your browser does not support WebGPU. Parley Protocol requires WebGPU to run AI models locally.
      <a href="https://developer.chrome.com/docs/web-platform/webgpu/#enable-webgpu" target="_blank" rel="noopener">Enable WebGPU</a> (Chrome/Edge 113+).
    </div>

    <!-- HERO with your background video (kept) -->
    <section class="hero">
      <video src="Intro sting.mp4" poster="Solana-coded UI background.png" autoplay muted playsinline loop></video>
      <div class="hero-overlay">
        <h2>Watch AIs debate the world’s hardest problems</h2>
        <p>Pose a deep, global question. Then watch 2–3 expert personas debate toward a joint plan — all in your browser, no servers.</p>
      </div>
    </section>

    <!-- COMPACT CONTROLS -->
    <section class="glass stack">
      <div class="controlbar">
        <div>
          <label>Big Question</label>
          <textarea id="question" maxlength="500" placeholder="e.g., How do we reduce the risk of great-power conflict while safeguarding smaller nations' sovereignty?"></textarea>
        </div>
        <div>
          <label>Model</label>
          <select id="model">
            <option value="Llama-3.1-8B-Instruct-q4f32_1-MLC">Llama-3.1-8B-Instruct</option>
            <option value="Qwen2-1.5B-Instruct-q4f32_1-MLC">Qwen2-1.5B-Instruct</option>
            <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi-3-Mini-4k-Instruct</option>
          </select>
        </div>
        <div>
          <label>Turns per agent</label>
          <input id="turns" type="number" min="1" max="5" value="2">
        </div>
        <div style="display:flex; gap:8px;">
          <button id="loadBtn" title="Load the selected model">Load Model</button>
          <button id="runBtn" disabled title="Run the multi-agent debate">Run Parley</button>
        </div>
      </div>

      <div>
        <label>Debate Goal / Instructions</label>
        <input id="goal" type="text" maxlength="300" value="Debate constructively and end with a short, concrete joint plan with 3 actionable steps and named risks.">
      </div>

      <div class="meter"><i id="meterBar"></i></div>
      <div class="tiny" id="status">Status: idle</div>
    </section>

    <!-- CHAT -->
    <section class="chat-wrap">
      <div class="chat" id="chat"></div>
    </section>

    <!-- ACTIONS -->
    <section class="glass" style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="postXBtn" class="btn-secondary" title="Post the debate to X" disabled>Post this conversation to X</button>
      <button id="copyLinkBtn" class="btn-secondary" title="Copy a shareable link" disabled>Copy permalink</button>
      <button id="saveBtn" class="btn-secondary" title="Publish to the Recent Debates feed" disabled>Make this debate public</button>
    </section>

    <!-- FEED -->
    <section class="glass">
      <h3 style="margin-bottom:8px">Recent Debates</h3>
      <div id="feed" class="feed"></div>
      <div class="tiny">Tip: shared globally via Supabase. Live updates enabled.</div>
    </section>

    <!-- MEET THE AGENTS -->
    <section class="glass meet">
      <img src="Agent archetypes panel.png" alt="AI agent archetypes: Realist Strategist, Humanitarian Diplomat, Data-Driven Technocrat">
      <div class="agents">
        <div class="agent">
          <h4>Agent A — Realist Strategist</h4>
          <p class="sys">Deterrence, credible commitments, incremental, verification-heavy policies.</p>
        </div>
        <div class="agent">
          <h4>Agent B — Humanitarian Diplomat</h4>
          <p class="sys">Human rights, corridors, confidence-building, inclusive governance, win-wins.</p>
        </div>
        <div class="agent">
          <h4>Agent C — Data-Driven Technocrat</h4>
          <p class="sys">Mechanism design, KPIs, pilots, incentive alignment, measurable outcomes.</p>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    // ====== CONFIG (paste ONLY your anon key) =================================
    const PARLEY_SUPABASE_URL = "https://eqbrwrkkrhjbotccqxis.supabase.co";
    const PARLEY_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxYnJ3cmtrcmhqYm90Y2NxeGlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjQwMjMsImV4cCI6MjA3MDYwMDAyM30.63xXq_e0cvALc8W8nA7gFGA7GEKAjXy61tlA7yJvHqQ"; // <- paste here
    // ========================================================================

    // Import libs
    const { createClient } = await import('https://esm.run/@supabase/supabase-js');
    // WebLLM loads later when requested

    // Supabase client (works even if key not pasted — site will just be local-only)
    const supabase = (PARLEY_SUPABASE_URL && PARLEY_SUPABASE_ANON_KEY && PARLEY_SUPABASE_ANON_KEY !== "PASTE_YOUR_SUPABASE_ANON_KEY_HERE")
      ? createClient(PARLEY_SUPABASE_URL, PARLEY_SUPABASE_ANON_KEY)
      : null;

    // UI refs
    const statusEl=document.getElementById('status');
    const meterBar=document.getElementById('meterBar');
    const runBtn=document.getElementById('runBtn');
    const loadBtn=document.getElementById('loadBtn');
    const saveBtn=document.getElementById('saveBtn');
    const postXBtn=document.getElementById('postXBtn');
    const copyLinkBtn=document.getElementById('copyLinkBtn');
    const feedEl=document.getElementById('feed');
    const toastEl=document.getElementById('toast');
    const chatEl=document.getElementById('chat');
    const questionEl=document.getElementById('question');
    const turnsEl=document.getElementById('turns');
    const goalEl=document.getElementById('goal');
    const modelEl=document.getElementById('model');
    const wgpuBanner=document.getElementById('wgpuBanner');

    // Personas (system prompts)
    const aEl={ value:"You are a Realist Strategist. You value state stability, deterrence, multipolar balance, incrementalism, and credible commitments. Avoid moralizing; emphasize tradeoffs and verification." };
    const bEl={ value:"You are a Humanitarian Diplomat. You prioritize human rights, humanitarian corridors, international law, confidence-building measures, and inclusive governance. Seek constructive-sum policies." };
    const cEl={ value:"You are a Data-Driven Technocrat. You lean on causal evidence, mechanism design, incentive alignment, and measurable KPIs. You translate ideals into testable policy pilots." };

    let engine=null;
    let lastQuestion="", lastSummary="", lastTranscript="", lastPublicId="";

    if(!('gpu' in navigator)){ wgpuBanner.style.display='block'; }

    // Utils
    function setStatus(t){ statusEl.textContent=t; }
    function setProgress(p){ meterBar.style.width=`${Math.max(2,Math.floor(p*100))}%`; }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
    }
    function toast(msg, type='ok'){ toastEl.textContent=msg; toastEl.className='toast '+type; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',2500); }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function formatTranscriptForDisplay(t){
      return (t||"").trim().replace(/\n{3,}/g,'\n\n').replace(/\[(A|B|C|Moderator)\]\s?/g, m=>`\n${m} `).trim();
    }
    function condenseForX(question, text){
      const base=`Q: ${question}\n`;
      let body=(text||"").replace(/\s+/g,' ').trim();
      if(body.length>220) body=body.slice(0,217)+'…';
      return base + body + '\n#ParleyProtocol';
    }

    // Local feed fallback
    function loadLocalFeed(){ try{ return JSON.parse(localStorage.getItem('parleyFeed')||'[]'); } catch{ return []; } }
    function saveLocalFeed(item){ const arr=loadLocalFeed(); arr.unshift(item); localStorage.setItem('parleyFeed', JSON.stringify(arr.slice(0,100))); }
    function getLocalById(id){ return loadLocalFeed().find(x=>x.id===id); }

    // Build UI feed
    function renderFeed(items){
      feedEl.innerHTML='';
      if(!items.length){ feedEl.innerHTML='<div class="tiny">No debates yet.</div>'; return; }
      for(const it of items){
        const card=document.createElement('div');
        card.className='feed-item';
        card.innerHTML=`
          <h5>${escapeHtml(it.question)}</h5>
          <div class="tiny" style="margin-bottom:6px">${new Date(it.created_at||Date.now()).toLocaleString()}</div>
          <small>${escapeHtml(it.summary||'')}</small>
          <div class="feed-tools">
            <button class="btn-secondary" data-expand="${it.id}">Expand</button>
            <button class="btn-secondary" data-copy="${it.id}">Copy link</button>
            <button class="btn-secondary" data-post="${it.id}">Post to X</button>
          </div>
          <div class="feed-details" id="details_${it.id}">${escapeHtml(formatTranscriptForDisplay(it.transcript||''))}</div>
        `;
        feedEl.appendChild(card);
      }
      // handlers
      feedEl.querySelectorAll('[data-expand]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id=e.currentTarget.getAttribute('data-expand');
          const container=e.currentTarget.closest('.feed-item');
          // if remote missing transcript, fetch it
          if(!document.getElementById('details_'+id).textContent.trim()){
            const data=await fetchById(id);
            if(data?.transcript) document.getElementById('details_'+id).textContent = formatTranscriptForDisplay(data.transcript);
          }
          container.classList.toggle('open');
        });
      });
      feedEl.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id=e.currentTarget.getAttribute('data-copy');
          await navigator.clipboard.writeText(permalinkForId(id));
          toast('Link copied.','ok');
        });
      });
      feedEl.querySelectorAll('[data-post]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id=e.currentTarget.getAttribute('data-post');
          const data=await fetchById(id);
          const text=condenseForX(data?.question||'', data?.summary||data?.transcript||'');
          const url=encodeURIComponent(text + '\n' + permalinkForId(id));
          window.open(`https://twitter.com/intent/tweet?text=${url}`, '_blank');
        });
      });
    }

    // Supabase helpers
    async function fetchPublicFeed(){
      if(!supabase) return [];
      const { data, error } = await supabase
        .from('debates')
        .select('id,question,summary,transcript,created_at')
        .order('created_at', { ascending:false })
        .limit(25);
      if(error){ console.warn(error); return []; }
      return data || [];
    }
    async function savePublic(item){
      if(!supabase) return null;
      const { data, error } = await supabase
        .from('debates')
        .insert(item)
        .select()
        .single();
      if(error){ console.warn(error); return null; }
      return data;
    }
    async function fetchById(id){
      // UUID -> remote; otherwise local
      const isUUID=/^[0-9a-f-]{36}$/i.test(id||'');
      if(isUUID && supabase){
        const { data, error } = await supabase
          .from('debates')
          .select('id,question,summary,transcript,created_at')
          .eq('id', id)
          .maybeSingle();
        if(!error && data) return data;
      }
      return getLocalById(id);
    }
    async function refreshFeed(){
      const local=loadLocalFeed();
      const remote=await fetchPublicFeed();
      const merged=[...remote, ...local].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
      renderFeed(merged);
    }

    // Realtime: live updates for everyone
    if(supabase){
      const channel = supabase.channel('public:debates')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'debates' }, (payload)=>{
          // Prepend newest item to UI quickly
          const it = payload.new;
          const current = [...feedEl.querySelectorAll('.feed-item')].length;
          if(current===0){ refreshFeed(); return; }
          // Minimal merge without refetch
          const newItem = { id:it.id, question:it.question, summary:it.summary, transcript:it.transcript, created_at:it.created_at };
          const existing = loadLocalFeed(); // local + remote not stored; just refetch to be accurate
          refreshFeed(); // safe & simple
        })
        .subscribe();
    }

    // Permalinks
    function permalinkForId(id){
      const url=new URL(location.href);
      url.search='?id='+encodeURIComponent(id);
      url.hash='';
      return url.toString();
    }

    // WebLLM
    async function loadModel(){
      setStatus('Importing WebLLM…');
      loadBtn.disabled=true;
      try{
        const webllm=await import('https://esm.run/@mlc-ai/web-llm');
        setStatus(`Loading model: ${modelEl.value}`);
        engine=await webllm.CreateMLCEngine(modelEl.value,{
          initProgressCallback:(p)=>{ setProgress(p.progress||0); setStatus(`Loading: ${Math.round((p.progress||0)*100)}% — ${p.text||''}`); }
        });
        runBtn.disabled=false;
        setStatus('Model ready.');
        setProgress(1);
      }catch(e){
        console.error(e);
        setStatus('Failed to load. Enable WebGPU (Chrome/Edge 113+).');
        loadBtn.disabled=false;
      }
    }
    async function generate(messages){
      const chunks=await engine.chat.completions.create({messages,stream:true,temperature:0.9});
      let reply='';
      for await(const ch of chunks){ reply += ch.choices?.[0]?.delta?.content || ''; }
      return reply.trim();
    }
    function buildPrompt(rolePrompt,userQ,goal){
      return [
        { role:'system', content:`${rolePrompt}\nGoal: ${goal}` },
        { role:'user', content:`Question: ${userQ}\nRespond concisely in 5–8 sentences.` }
      ];
    }
    function rebuttalPrompt(rolePrompt, transcript, goal){
      return [
        { role:'system', content:`${rolePrompt}\nGoal: ${goal}` },
        { role:'user', content:`Transcript so far:\n${transcript}\nWrite your next turn with specifics and a concrete proposal.` }
      ];
    }
    function synthPrompt(transcript){
      return [
        { role:'system', content:'You are the Moderator. Synthesize agreement/tension into a realistic plan.' },
        { role:'user', content:`Create a final outcome based on this debate:\n${transcript}\nOutput:\n1) Joint Plan: three concrete steps.\n2) Risks: two bullets + mitigations.\n3) Open Question: one unresolved issue.` }
      ];
    }

    // Run debate
    async function runParley(){
      if(!engine) return alert('Load a model first.');
      chatEl.innerHTML='';
      saveBtn.disabled=true; postXBtn.disabled=true; copyLinkBtn.disabled=true; lastPublicId='';

      const q=(questionEl.value||"").trim();
      if(q.length<4){ toast('Please enter a longer question (≥ 4 chars).','bad'); return; }
      const turns=Math.max(1, Math.min(5, parseInt(turnsEl.value||'2',10)));
      const goal=(goalEl.value||"").trim();

      const personas=[];
      if(aEl.value.trim()) personas.push(['A', aEl.value.trim()]);
      if(bEl.value.trim()) personas.push(['B', bEl.value.trim()]);
      if(cEl.value.trim()) personas.push(['C', cEl.value.trim()]);
      if(personas.length<2) return alert('Please keep at least two agents.');

      let transcript='';

      setStatus('Generating opening statements…');
      for(const [tag,prompt] of personas){
        const msg=await generate(buildPrompt(prompt,q,goal));
        transcript+=`\n\n[${tag}] ${msg}`;
        const div=document.createElement('div'); div.className='bubble agent'+tag; div.textContent=msg; chatEl.appendChild(div);
      }

      setStatus('Running debate…');
      for(let t=0; t<turns-1; t++){
        for(const [tag,prompt] of personas){
          const msg=await generate(rebuttalPrompt(prompt, transcript.slice(-4000), goal));
          transcript+=`\n\n[${tag}] ${msg}`;
          const div=document.createElement('div'); div.className='bubble agent'+tag; div.textContent=msg; chatEl.appendChild(div);
        }
      }

      setStatus('Synthesizing…');
      const mod=await generate(synthPrompt(transcript.slice(-6000)));
      const divM=document.createElement('div'); divM.className='bubble'; divM.textContent=mod; chatEl.appendChild(divM);
      setStatus('Done.');

      lastQuestion=q;
      lastTranscript=(transcript + `\n\n[Moderator] ${mod}`).trim();
      lastSummary = (mod||'').replace(/\s+/g,' ').trim().slice(0,1200);

      saveBtn.disabled=false;
      postXBtn.disabled=false;
      copyLinkBtn.disabled=false;
    }

    // Post/save/permalink
    function permalinkForCurrent(){ return lastPublicId ? permalinkForId(lastPublicId) : ''; }

    postXBtn.addEventListener('click', ()=>{
      if(!lastQuestion) return;
      const text = condenseForX(lastQuestion, lastSummary || lastTranscript);
      const link = lastPublicId ? '\n' + permalinkForCurrent() : '';
      const url  = encodeURIComponent(text + link);
      window.open(`https://twitter.com/intent/tweet?text=${url}`, '_blank');
    });

    copyLinkBtn.addEventListener('click', async ()=>{
      // If not saved yet, create a local ID so the link resolves on this device
      let id = lastPublicId;
      if(!id){
        id = uid();
        saveLocalFeed({ id, question:lastQuestion, summary:lastSummary, transcript:lastTranscript, created_at:new Date().toISOString() });
        await refreshFeed();
      }
      await navigator.clipboard.writeText(permalinkForId(id));
      toast('Permalink copied to clipboard.','ok');
    });

    saveBtn.addEventListener('click', async ()=>{
      if(!lastQuestion || !lastSummary) return;
      const item={ question:lastQuestion.slice(0,500), summary:lastSummary.slice(0,1200), transcript:lastTranscript.slice(0,20000), created_at:new Date().toISOString() };
      // local id fallback
      const localId = uid();
      saveLocalFeed({ id:localId, ...item });
      let remote=null;
      if(supabase){ remote = await savePublic(item); }
      lastPublicId = (remote?.id) || localId;
      await refreshFeed();
      toast(remote?.id ? 'Debate made public.' : 'Saved locally (public feed off).','ok');
    });

    // Boot: handle permalinks + initial feed
    (async ()=>{
      const qs=new URLSearchParams(location.search);
      const id=qs.get('id');
      if(id){
        const data=await fetchById(id);
        if(data?.transcript){
          // render into chat
          chatEl.innerHTML='';
          const lines=(data.transcript||'').split(/\n+/);
          for(const line of lines){
            if(!line.trim()) continue;
            let tag='A'; if(line.startsWith('[B]')) tag='B'; else if(line.startsWith('[C]')) tag='C'; else if(line.startsWith('[Moderator]')) tag='M';
            const div=document.createElement('div'); div.className='bubble ' + (tag==='M'?'':'agent'+tag); div.textContent=line.replace(/^\[(A|B|C|Moderator)\]\s?/, ''); chatEl.appendChild(div);
          }
          lastPublicId=id; lastQuestion=data.question||''; lastSummary=data.summary||''; lastTranscript=data.transcript||'';
          saveBtn.disabled=false; postXBtn.disabled=false; copyLinkBtn.disabled=false;
        }
      }
      await refreshFeed();
      if(!('gpu' in navigator)) toast('WebGPU not detected. Enable it to load a model.','bad');
    })();

    // Wire up buttons
    loadBtn.addEventListener('click', loadModel);
    runBtn.addEventListener('click', runParley);
  </script>
</body>
</html>
