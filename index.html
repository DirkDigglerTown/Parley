<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parley Protocol — Multi-Agent LLM Debates</title>
  <meta name="description" content="Watch AI agents debate deep ...in your browser — no servers, no paid APIs. WebGPU + WebLLM." />

  <!-- Favicon & social preview -->
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />
  <meta property="og:title" content="Parley Protocol — Multi-Agent LLM Debates" />
  <meta property="og:description" content="Pose a deep question ...AI personas debate toward a joint plan — all on your device." />
  <meta property="og:image" content="https://parleyprotocol.codes/social-preview.png" />
  <meta property="og:url" content="https://parleyprotocol.codes/" />
  <meta property="og:type" content="website" />

  <!-- Performance hints -->
  <link rel="preconnect" href="https://esm.run" />
  <link rel="preconnect" href="https://huggingface.co" />
  <link rel="preconnect" href="https://raw.githubusercontent.com" />

  <style>
    :root{
      --bg:#0A0E14; --panel:#0E141C; --panel2:#0C1218; --text:#EAF2FF; --muted:#A7B1C2;
      --accent:#39E5C2; --accent2:#B08CFF; --bad:#FF5C8A; --good:#3BE07D; --outline:#1D2734;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text); background:radial-gradient(1200px 600px at 75% -10%, rgba(80,40,130,.25), transparent),
      radial-gradient(1200px 600px at 5% 90%, rgba(0,202,170,.18), transparent), var(--bg);}
    a{color:inherit}
    .wrap{min-height:100vh; display:flex; flex-direction:column}
    header{position:sticky; top:0; z-index:2; backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(10,14,20,.92), rgba(10,14,20,.65));
      border-bottom:1px solid var(--outline);
    }
    .nav{width:min(1100px,92vw); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:28px; width:auto; filter:drop-shadow(0 2px 8px rgba(0,229,255,.15))}
    .brand h1{font-size:18px; font-weight:800; letter-spacing:.2px}
    .credit{font-size:12px; color:var(--muted)}
    .credit a{color:var(--accent)}
    main{position:relative; z-index:1; width:min(1100px,92vw); margin:0 auto; padding:20px 0 80px; display:grid; gap:18px}

    .wgpu-warning{display:none; background:rgba(255,92,138,0.12); color:#FFBDD0; border:1px solid rgba(255,92,138,0.35); padding:10px 12px; border-radius:10px; font-size:14px}

    .hero{position:relative; overflow:hidden; min-height:48vh; border-radius:18px; border:1px solid var(--outline)}
    .hero video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; pointer-events:none; filter:contrast(1.05) saturate(1.1) brightness(.8)}
    .hero .glass{position:relative; z-index:1; background:linear-gradient(180deg, rgba(13,18,26,.75), rgba(13,18,26,.45)); border-top:1px solid #17202C}
    .hero .inner{display:grid; grid-template-columns: 1fr; gap:14px; padding:16px}
    .hero h2{font-size:16px; font-weight:700; color:var(--muted); letter-spacing:.25px}
    .hero .controls{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .hero input, .hero textarea, .hero select{width:100%; border-radius:12px; border:1px solid #1C2735; background:linear-gradient(180deg, #0F1520, #0C1219); color:var(--text); padding:10px 12px; outline:none; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.03)}
    .hero textarea{min-height:82px; resize:vertical}
    .hero .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{border-radius:12px; border:1px solid #243144; background:linear-gradient(180deg, #0F1724, #0B1119); color:var(--text); padding:10px 14px; font-weight:600; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg, #0C1C1B, #0A1313); border-color:#18302E}
    .btn-success{border-color:#1f3f2c}
    .btn-pulse{animation:pulse .6s}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(59,224,125,.6)}100%{box-shadow:0 0 0 12px rgba(59,224,125,0)}}

    .progress{height:4px; background:#0E1420; border-radius:999px; overflow:hidden; border:1px solid #1B2533}
    .progress .bar{height:100%; width:2%; background:linear-gradient(90deg, var(--accent), var(--accent2)); transition:width .15s ease}

    .grid{display:grid; grid-template-columns: 1fr; gap:16px}
    .cols{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width:880px){ .cols{grid-template-columns:1fr} }

    .feed{border:1px solid var(--outline); border-radius:14px; background:linear-gradient(180deg, #0E141D, #0C1218)}
    .feed .item{padding:12px; border-top:1px solid #131A25}
    .feed .item:first-child{border-top:none}
    .feed small{color:var(--muted)}
    .feed .item h4{margin:0 0 6px; font-size:14px}
    .feed .item pre{white-space:pre-wrap}

    .chat{display:grid; gap:10px}
    .bubble{border:1px solid var(--outline); background:linear-gradient(180deg, #0E141D, #0C1218); padding:12px; border-radius:12px; line-height:1.5}
    .agentA{border-color:#114141; box-shadow:0 0 0 1px rgba(57,229,194,0.08) inset}
    .agentB{border-color:#332455; box-shadow:0 0 0 1px rgba(176,140,255,0.07) inset}
    .agentC{border-color:#34405e; box-shadow:0 0 0 1px rgba(105,156,255,0.07) inset}

    .toast{display:none; position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:linear-gradient(180deg, #10202B, #0B141B); border:1px solid #1C2B39; padding:10px 14px; border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="nav">
      <div class="brand">
        <img src="ParleyLogo.png" alt="Parley logo" />
        <h1>Parley Protocol</h1>
      </div>
      <div class="credit">
        Built with WebGPU + WebLLM. <a href="https://github.com/" target="_blank" rel="noreferrer">Source</a>
      </div>
    </div>
  </header>

  <main>
    <div id="wgpuBanner" class="wgpu-warning">WebGPU not detected. Use Chrome/Edge 113+ and enable it in chrome://flags.</div>

    <section class="hero">
      <video src="Intro sting.mp4" autoplay muted loop playsinline></video>
      <div class="glass">
        <div class="inner">
          <h2>Ask a hard question. Agents will debate and the moderator will synthesize.</h2>

          <div class="controls">
            <input id="question" placeholder="Your question…" />
            <select id="turns" title="Turns">
              <option value="2">2 turns</option>
              <option value="3">3 turns</option>
              <option value="4">4 turns</option>
              <option value="5">5 turns</option>
            </select>
          </div>

          <textarea id="goal" placeholder="Optional: state a concrete goal (KPIs, constraints, success metric)"></textarea>

          <div class="row">
            <select id="model" title="Model">
            <option value="Qwen2-1.5B-Instruct-q4f32_1-MLC" selected>Qwen2-1.5B-Instruct</option>
            <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi-3-Mini-4k-Instruct</option>
            <option value="Llama-3.1-8B-Instruct-q4f32_1-MLC">Llama-3.1-8B-Instruct</option>
          </select>
            <div class="btns">
              <button id="loadBtn" class="btn-primary">Load model</button>
              <button id="runBtn" class="btn-primary" disabled>Run debate</button>
            </div>
          </div>

          <div class="progress"><div id="meterBar" class="bar"></div></div>
          <div id="status" aria-live="polite">Idle.</div>
        </div>
      </div>
    </section>

    <section class="cols">
      <div class="grid">
        <h3>Debate</h3>
        <div id="chat" class="chat"></div>
      </div>

      <div class="grid">
        <h3>Public Feed</h3>
        <div class="btns" style="align-items:center;">
          <label><input type="checkbox" id="hideLocalToggle" /> Hide local-only</label>
          <button id="clearLocalBtn">Clear local</button>
          <button id="saveBtn" disabled>Save debate</button>
          <button id="postXBtn" disabled>Post to X</button>
        </div>
        <div id="feed" class="feed"></div>
      </div>
    </section>

    <div class="toast" id="toast"></div>
  </main>
</div>

<script type="module">
    /* ====== CONFIG ====== */
    const PARLEY_SUPABASE_URL = "https://eqbrwrkkrhjbotccqxis.supabase.co";
    const PARLEY_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cC...e0cvALc8W8nA7gFGA7GEKAjXy61tlA7yJvHqQ"; /* <-- paste anon key */

    /* Libs */
    const { createClient } = await import('https://esm.run/@supabase/supabase-js@2.45.4');

    /* Supabase client (null -> local-only mode) */
    const supabase = (PARLEY_SUPABASE_URL && PARLEY_SUPABASE_ANON_KEY && PARLEY_SUPABASE_ANON_KEY !== "PASTE_YOUR_SUPABASE_ANON_KEY_HERE")
      ? createClient(PARLEY_SUPABASE_URL, PARLEY_SUPABASE_ANON_KEY)
      : null;

    /* UI refs */
    const statusEl=document.getElementById('status');
    const meterBar=document.getElementById('meterBar');
    const runBtn=document.getElementById('runBtn');
    const loadBtn=document.getElementById('loadBtn');
    const saveBtn=document.getElementById('saveBtn');
    const postXBtn=document.getElementById('postXBtn');
    const feedEl=document.getElementById('feed');
    const toastEl=document.getElementById('toast');
    const chatEl=document.getElementById('chat');
    const questionEl=document.getElementById('question');
    const turnsEl=document.getElementById('turns');
    const goalEl=document.getElementById('goal');
    const modelEl=document.getElementById('model');
    const wgpuBanner=document.getElementById('wgpuBanner');
    const hideLocalToggle=document.getElementById('hideLocalToggle');
    const clearLocalBtn=document.getElementById('clearLocalBtn');

    /* Personas */
    const aEl={ value:"You are a Realist Strategist. You value s...nts. Avoid moralizing; emphasize tradeoffs and verification." };
    const bEl={ value:"You are a Humanitarian Diplomat. You prio...s, and inclusive governance. Seek constructive-sum policies." };
    const cEl={ value:"You are a Data-Driven Technocrat. You lea...able KPIs. You translate ideals into testable policy pilots." };

    let engine=null;
    let lastQuestion="", lastSummary="", lastTranscript="", lastPublicId="";

    if(!('gpu' in navigator)){ wgpuBanner.style.display='block'; }

    /* Utils */
    function setStatus(t){ statusEl.textContent=t; }
    function setProgress(p){ meterBar.style.width=`${Math.max(2,Math.floor(p*100))}%`; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
    function toast(msg, type='ok'){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',2500); }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function isUUID(id){ return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(id||''); }

    /* Parse transcript into role blocks */
    function parseTranscriptBlocks(t){
      const blocks=[]; if(!t) return blocks;
      const re=/\[(A|B|C|Moderator)\]\s*/g;
      let m, lastIdx=0, role=null;
      while((m=re.exec(t))!==null){
        if(role){
          const chunk=t.slice(lastIdx, m.index).trim();
          if(chunk) blocks.push({ role, text:chunk });
        }
        role=m[1]; lastIdx=re.lastIndex;
      }
      if(role){
        const tail=t.slice(lastIdx).trim();
        if(tail) blocks.push({ role, text:tail });
      }
      return blocks;
    }

    /* Feed UI (unchanged core) */
    function renderFeed(items){
      const rows = items.map(it=>{
        const id = it.id;
        const date = new Date(it.created_at || Date.now()).toLocaleString();
        const question = escapeHtml(it.question||'');
        const summary = escapeHtml(it.summary||'');
        const isPublic = isUUID(id);
        return `
          <div class="item">
            <h4>${question} <small>— ${date}</small></h4>
            <pre>${summary}</pre>
            <div class="btns">
              <button data-copy="${id}">Copy link</button>
              ${isPublic? `<button data-post="${id}">Post to X</button>`:``}
            </div>
          </div>
        `;
      }).join('');
      feedEl.innerHTML = rows || '<div class="item"><small>No debates yet.</small></div>';

      feedEl.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id=e.currentTarget.getAttribute('data-copy');
          await navigator.clipboard.writeText(permalinkForId(id));
          buttonFlashSuccess(e.currentTarget, "Copied ✓");
        });
      });
      feedEl.querySelectorAll('[data-post]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id=e.currentTarget.getAttribute('data-post');
          const data=await fetchById(id);
          const tweet = buildTweetText(data?.question||'', permalinkForId(id));
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweet)}`, '_blank');
        });
      });
    }

    /* Supabase helpers */
    async function fetchPublicFeed(){
      if(!supabase) return [];
      const { data, error } = await supabase
        .from('debates')
        .select('id,question,summary,transcript,created_at')
        .order('created_at', { ascending:false })
        .limit(25);
      if(error){ console.warn(error); return []; }
      return data || [];
    }
    async function savePublic(item){
      if(!supabase) return null;
      const { data, error } = await supabase
        .from('debates')
        .insert(item)
        .select('id')
        .single();
      if(error){ console.warn(error); return null; }
      return data;
    }
    async function fetchById(id){
      if(!id) return null;
      if(isUUID(id) && supabase){
        const { data, error } = await supabase.from('debates').select('id,question,summary,transcript,created_at').eq('id', id).single();
        if(error){ console.warn(error); return null; }
        return data;
      }
      return getLocalById(id);
    }

    async function refreshFeed(){
      const local=loadLocalFeed();
      const remote=await fetchPublicFeed();
      let merged=[...remote, ...local].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
      if(hideLocalToggle?.checked){ merged = merged.filter(it => isUUID(it.id)); }
      renderFeed(merged);
    }

    if(supabase){
      supabase.channel('public:debates')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'debates' }, () => refreshFeed())
        .subscribe();
    }

    function permalinkForId(id){
      const url=new URL(location.href);
      url.search='?id='+encodeURIComponent(id);
      url.hash='';
      return url.toString();
    }
    function buildTweetText(question, link){
      const t = `Parley Protocol — “${(question||'').slice(0,120)}”\\n\\n` + link;
      return t;
    }

    /* Local feed storage */
    function loadLocalFeed(){
      try{ return JSON.parse(localStorage.getItem('parleyFeed')||'[]'); }catch{ return []; }
    }
    function saveLocalFeed(item){
      const arr=loadLocalFeed();
      arr.unshift(item);
      localStorage.setItem('parleyFeed', JSON.stringify(arr.slice(0,100)));
    }
    function getLocalById(id){ return loadLocalFeed().find(x=>x.id===id); }

    /* Button success flash */
    function buttonFlashSuccess(btn, label="Copied ✓"){
      const prev = btn.textContent;
      btn.textContent = label;
      btn.classList.add('btn-success','btn-pulse');
      setTimeout(()=>{ btn.textContent=prev; btn.classList.remove('btn-success','btn-pulse'); }, 1000);
    }

    /* Model prompts */
    function buildPrompt(rolePrompt,userQ,goal){
      return [
        { role:'system', content:`${rolePrompt}\\nGoal: ${goal}` },
        { role:'user', content:`Question: ${userQ}\\nRespond concisely in 5–8 sentences.` }
      ];
    }
    function rebuttalPrompt(rolePrompt, transcript, goal){
      return [
        { role:'system', content:`${rolePrompt}\\nGoal: ${goal}` },
        { role:'user', content:`Transcript so far:\\n${transcript}\\nWrite your next turn with specifics and a concrete proposal.` }
      ];
    }
    function synthPrompt(transcript){
      return [
        { role:'system', content:'You are the Moderator. Synthesize agreement/tension into a realistic plan.' },
        { role:'user', content:`Create a final outcome based on the full debate. Structure:
1) Joint Plan: concise bullet list with concrete actions, owners, timelines, measurable KPIs.
2) Risks & Mitigations: bullets + mitigations.
3) Open Question: one unresolved issue.` }
      ];
    }

    /* WebLLM: loader (with WebGPU warm-up) */
    async function loadModel(){
      try{ const adapter = await navigator.gpu?.requestAdapter?.({powerPreference:'high-performance'}); await adapter?.requestDevice?.(); }catch(e){}
      setStatus('Importing WebLLM…');
      loadBtn.disabled=true;
      try{
        const webllm=await import('https://esm.run/@mlc-ai/web-llm@0.2.74');
        setStatus(`Loading model: ${modelEl.value}`);
        engine=await webllm.CreateMLCEngine(modelEl.value,{
          initProgressCallback:(p)=>{ setProgress(p.progress||0); setStatus(`Loading: ${Math.round((p.progress||0)*100)}% — ${p.text||''}`); }
        });
        runBtn.disabled=false;
        setStatus('Model ready.');
        setProgress(1);
      }catch(e){
        console.error(e);
        setStatus('Failed to load. Enable WebGPU (Chrome/Edge 113+).');
        loadBtn.disabled=false;
      }
    }

    /* Generators */
    async function generate(messages){
      // legacy: buffered generation (fallback)
      const chunks=await engine.chat.completions.create({messages,stream:true,temperature:0.8,max_tokens:220});
      let reply=''; for await(const ch of chunks){ reply += ch.choices?.[0]?.delta?.content || ''; }
      return reply.trim();
    }
    async function generateStreaming(messages, targetDiv, {temperature=0.8, max_tokens=220}={}){
      const chunks=await engine.chat.completions.create({messages,stream:true,temperature,max_tokens});
      let reply='';
      for await(const ch of chunks){
        const piece = ch.choices?.[0]?.delta?.content || '';
        if(!piece) continue;
        reply += piece;
        if(targetDiv){ targetDiv.textContent = reply; targetDiv.scrollIntoView({block:'end'}); }
      }
      return reply.trim();
    }

    /* Run debate (streaming + parallel per round) */
    async function runParley(){
      if(!engine) return alert('Load a model first.');
      chatEl.innerHTML='';
      saveBtn.disabled=true; postXBtn.disabled=true; lastPublicId='';

      const q=(questionEl.value||"").trim();
      if(q.length<4){ toast('Please enter a longer question (≥ 4 chars).','bad'); return; }
      const turns=Math.max(1, Math.min(5, parseInt(turnsEl.value||'2',10)));
      const goal=(goalEl.value||"").trim();

      const personas=[];
      if(aEl.value.trim()) personas.push(['A', aEl.value.trim()]);
      if(bEl.value.trim()) personas.push(['B', bEl.value.trim()]);
      if(cEl.value.trim()) personas.push(['C', cEl.value.trim()]);
      if(personas.length<2) return alert('Please keep at least two agents.');

      let transcript='';

      // Opening statements in parallel, streaming to UI
      setStatus('Generating opening statements…');
      {
        const jobs = personas.map(([tag,prompt])=>{
          const div=document.createElement('div'); div.className='bubble agent'+tag; chatEl.appendChild(div);
          return generateStreaming(buildPrompt(prompt,q,goal), div, {max_tokens:220, temperature:0.8}).then(msg=>({tag,msg}));
        });
        const results = await Promise.all(jobs);
        for(const {tag,msg} of results){ transcript += `\n\n[${tag}] ${msg}`; }
      }

      // Debate rounds with parallel agent turns per round
      setStatus('Running debate…');
      for(let t=0; t<turns-1; t++){
        const snap = transcript.slice(-3000);
        const jobs = personas.map(([tag,prompt])=>{
          const div=document.createElement('div'); div.className='bubble agent'+tag; chatEl.appendChild(div);
          return generateStreaming(rebuttalPrompt(prompt, snap, goal), div, {max_tokens:220, temperature:0.8}).then(msg=>({tag,msg}));
        });
        const results = await Promise.all(jobs);
        for(const {tag,msg} of results){ transcript += `\n\n[${tag}] ${msg}`; }
      }

      // Moderator synthesis (slightly higher cap)
      setStatus('Synthesizing…');
      const divM=document.createElement('div'); divM.className='bubble'; chatEl.appendChild(divM);
      const mod=await generateStreaming(synthPrompt(transcript.slice(-4500)), divM, {max_tokens:280, temperature:0.8});
      setStatus('Done.');

      lastQuestion=q;
      lastTranscript=(transcript + `\n\n[Moderator] ${mod}`).trim();
      lastSummary = (mod||'').replace(/\s+/g,' ').trim().slice(0,1200);

      saveBtn.disabled=false;
      postXBtn.disabled=false;
    }

    /* Save / Post */
    function isLikelyDuplicate(question){
      const norm = (question||'').trim().toLowerCase();
      const tenMinAgo = Date.now() - 10*60*1000;
      const items = loadLocalFeed();
      for(const it of items){
        if((it.created_at && new Date(it.created_at).getTime() >= tenMinAgo) &&
           (it.question||'').trim().toLowerCase() === norm){
          return true;
        }
      }
      return false;
    }

    saveBtn.addEventListener('click', async ()=>{
      if(!lastQuestion || !lastSummary) return;

      if(isLikelyDuplicate(lastQuestion)){
        toast('Looks like this question was just saved. Try again later.','bad');
        return;
      }

      const item = {
        id: uid(),
        question: lastQuestion,
        summary: lastSummary,
        transcript: lastTranscript,
        created_at: new Date().toISOString()
      };

      const localId = item.id;
      saveLocalFeed(item);

      let remote=null;
      if(supabase){ remote = await savePublic(item); }
      lastPublicId = (remote?.id) || localId;

      await refreshFeed();
      toast(remote?.id ? 'Debate made public.' : 'Saved locally (public feed off).','ok');
    });

    postXBtn.addEventListener('click', ()=>{
      if(!lastQuestion) return;
      const link = lastPublicId ? permalinkForId(lastPublicId) : window.location.href;
      const tweet = buildTweetText(lastQuestion, link);
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweet)}`, '_blank');
    });

    /* Boot */
    (async ()=>{
      // apply persisted toggle default
      const hidePref = localStorage.getItem('parley_hide_local');
      if(hidePref !== null){ hideLocalToggle.checked = hidePref === '1'; }
      hideLocalToggle.addEventListener('change', ()=>{ localStorage.setItem('parley_hide_local', hideLocalToggle.checked?'1':'0'); refreshFeed(); });
      clearLocalBtn.addEventListener('click', ()=>{ localStorage.removeItem('parleyFeed'); refreshFeed(); toast('Local feed cleared.','ok'); });

      const qs=new URLSearchParams(location.search);
      const id=qs.get('id');
      if(id){
        const data=await fetchById(id);
        if(data?.transcript){
          chatEl.innerHTML='';
          const blocks = parseTranscriptBlocks(data.transcript);
          for(const b of blocks){
            const div=document.createElement('div');
            div.className = 'bubble' + (b.role==='A'?' agentA': b.role==='B'?' agentB': b.role==='C'?' agentC':'');
            div.textContent=b.text;
            chatEl.appendChild(div);
          }
          lastPublicId=id; lastQuestion=data.question||''; lastSummary=data.summary||''; lastTranscript=data.transcript||'';
          saveBtn.disabled=false; postXBtn.disabled=false;
        }
      }
      await refreshFeed();
      if(!('gpu' in navigator)) toast('WebGPU not detected. Enable it to load a model.','bad');
    })();

    /* Wire up buttons */
    loadBtn.addEventListener('click', loadModel);
    runBtn.addEventListener('click', runParley);
</script>
</body>
</html>
