<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parley Protocol — Multi-Agent LLM Debates</title>
  <meta name="description" content="Watch AI agents debate deep questions in your browser — no servers, no API keys. Runs on WebGPU via WebLLM." />
  <link rel="preconnect" href="https://esm.run" />
  <style>
    :root{
      --bg:#05070c; --fg:#e6f1ff; --muted:#9bb0c8; --glass:rgba(255,255,255,.06);
      --accent:#00e5ff; --accent2:#7c4dff; --good:#00e27b; --warn:#ffd166; --bad:#ff5c8a;
      --outline:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%}

    /* Global background (your still + overlay) */
    body{
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--fg);
      overflow-x:hidden;
      background-color:var(--bg);
      background-image:
        linear-gradient(180deg, rgba(4,6,12,.88), rgba(4,6,12,.70)),
        url("Solana-coded UI background.png");
      background-position:center center;
      background-size:cover;
      background-attachment:fixed;
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(10,14,20,.92), rgba(10,14,20,.65));
      border-bottom:1px solid var(--outline);
    }
    .nav{width:min(1100px,92vw); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:28px; width:auto; display:block; filter:drop-shadow(0 2px 8px rgba(0,229,255,.15))}
    .brand h1{font-size:18px; font-weight:800; letter-spacing:.2px}
    .credit{font-size:12px; color:var(--muted)}
    .credit a{color:var(--accent)}

    main{position:relative; z-index:1; width:min(1100px,92vw); margin:0 auto; padding:22px 0 84px; display:grid; gap:18px}

    /* WebGPU banner */
    .wgpu-warning{display:none; background:rgba(255,92,138,0.12); border:1px solid var(--bad); color:var(--bad); padding:10px 12px; border-radius:10px; font-size:14px}

    /* Hero */
    .hero{position:relative; overflow:hidden; min-height:52vh; border-radius:18px; border:1px solid var(--outline)}
    .hero video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; pointer-events:none; filter:contrast(1.08) saturate(1.05) brightness(.9)}
    .hero-overlay{position:relative; z-index:2; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center; text-align:center; min-height:52vh; padding:24px; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25))}
    .hero-overlay h2{font-size:clamp(28px,4.2vw,48px); line-height:1.05}
    .hero-overlay p{color:var(--muted); max-width:720px}

    /* Cards & controls */
    .glass{background:var(--glass); border:1px solid var(--outline); border-radius:18px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .stack{display:grid; gap:12px}

    /* Compact control bar */
    .controlbar{
      display:grid;
      grid-template-columns: 1fr 220px 170px 170px;
      gap:10px;
      align-items:end;
    }
    @media (max-width:860px){
      .controlbar{grid-template-columns:1fr 1fr; grid-auto-rows:auto}
    }
    label{font-size:12px; color:var(--muted)}
    textarea,select,input,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(10,14,22,.65); color:var(--fg)}
    textarea{min-height:64px; resize:vertical}
    button{cursor:pointer; background:linear-gradient(90deg, var(--accent), var(--accent2)); font-weight:700; border:none}
    .btn-secondary{background:rgba(255,255,255,.06); border:1px solid var(--outline)}

    .agents{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:880px){ .agents{grid-template-columns:1fr} }
    .agent{background:rgba(255,255,255,.04); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.1)}
    .agent h4{margin-bottom:6px}
    .sys{font-size:12px; color:var(--muted)}
    .meter{height:8px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .meter>i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2))}
    .tiny{font-size:11px; color:var(--muted)}

    /* Chat */
    .chat-wrap{position:relative; overflow:hidden; border-radius:16px; border:1px solid var(--outline)}
    .chat-bg video{width:100%; height:100%; object-fit:cover; filter:blur(1px) brightness(.85); pointer-events:none}
    .chat{position:relative; z-index:1; max-height:56vh; overflow:auto; padding:14px; display:grid; gap:8px; background:linear-gradient(180deg, rgba(3,6,12,.78), rgba(3,6,12,.6))}
    .bubble{padding:11px 12px; border-radius:12px; background:rgba(6,10,16,.6); border:1px solid rgba(255,255,255,.1); line-height:1.45}
    .agentA{border-left:3px solid var(--accent)}
    .agentB{border-left:3px solid var(--good)}
    .agentC{border-left:3px solid var(--bad)}

    /* Feed */
    .feed{display:grid; gap:10px}
    .feed-item{border:1px solid var(--outline); border-radius:14px; padding:12px; background:rgba(255,255,255,.04)}
    .feed-item h5{margin:0 0 6px 0; font-size:14px}
    .feed-item small{color:var(--muted)}

    /* Meet the Agents section */
    .meet{display:grid; gap:12px}
    .meet img{width:100%; border-radius:12px; display:block}

    @media (max-width:640px){
      .chat{max-height:50vh}
      .hero{min-height:48vh}
      .brand img{height:24px}
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <img src="ParleyLogo.png" alt="Parley Protocol logo" />
        <h1>Parley Protocol</h1>
      </div>
      <div class="credit">Powered by <a href="https://webllm.mlc.ai/" target="_blank" rel="noopener">WebLLM</a></div>
    </div>
  </header>

  <main>
    <div id="wgpuBanner" class="wgpu-warning">
      ⚠️ Your browser does not support WebGPU. Parley Protocol requires WebGPU to run AI models locally.
      <a href="https://developer.chrome.com/docs/web-platform/webgpu/#enable-webgpu" target="_blank" rel="noopener">Enable WebGPU</a> (Chrome/Edge 113+).
    </div>

    <!-- HERO -->
    <section class="hero">
      <video src="Intro sting.mp4" poster="Solana-coded UI background.png" autoplay muted playsinline loop></video>
      <div class="hero-overlay">
        <h2>Watch AIs debate the world’s hardest problems</h2>
        <p>Pose a deep, global question. Then watch 2–3 expert personas debate toward a joint plan — all in your browser, no servers.</p>
      </div>
    </section>

    <!-- COMPACT CONTROLS -->
    <section class="glass stack">
      <div class="controlbar">
        <div>
          <label>Big Question</label>
          <textarea id="question" placeholder="e.g., How do we reduce the risk of great-power conflict while safeguarding smaller nations' sovereignty?"></textarea>
        </div>
        <div>
          <label>Model</label>
          <select id="model">
            <option value="Llama-3.1-8B-Instruct-q4f32_1-MLC">Llama-3.1-8B-Instruct</option>
            <option value="Qwen2-1.5B-Instruct-q4f32_1-MLC">Qwen2-1.5B-Instruct</option>
            <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi-3-Mini-4k-Instruct</option>
          </select>
        </div>
        <div>
          <label>Turns per agent</label>
          <input id="turns" type="number" value="2">
        </div>
        <div style="display:flex; gap:8px;">
          <button id="loadBtn" title="Load the selected model">Load Model</button>
          <button id="runBtn" disabled title="Run the multi-agent debate">Run Parley</button>
        </div>
      </div>

      <div>
        <label>Debate Goal / Instructions</label>
        <input id="goal" type="text" value="Debate constructively and end with a short, concrete joint plan with 3 actionable steps and named risks.">
      </div>

      <div class="meter"><i id="meterBar"></i></div>
      <div class="tiny" id="status">Status: idle</div>
    </section>

    <!-- CHAT -->
    <section class="chat-wrap">
      <div class="chat-bg">
        <video src="Background loop for chat area.mp4" poster="Neon debate chamber.png" autoplay muted playsinline loop></video>
      </div>
      <div class="chat" id="chat"></div>
    </section>

    <!-- ACTIONS under chat -->
    <section class="glass" style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="postXBtn" class="btn-secondary" title="Post the debate to X (Twitter)" disabled>Post this conversation to X</button>
      <button id="saveBtn" class="btn-secondary" title="Save to Recent Debates (and public feed if enabled)" disabled>Save to Feed</button>
    </section>

    <!-- FEED -->
    <section class="glass">
      <h3 style="margin-bottom:8px">Recent Debates</h3>
      <div id="feed" class="feed"></div>
      <div class="tiny">Tip: this shows local saves by default. You can enable the public feed (free) — see code comments below.</div>
    </section>

    <!-- MEET THE AGENTS -->
    <section class="glass meet">
      <img src="Agent archetypes panel.png" alt="AI agent archetypes: Realist Strategist, Humanitarian Diplomat, Data-Driven Technocrat">
      <div class="agents">
        <div class="agent">
          <h4>Agent A — Realist Strategist</h4>
          <p class="sys">Deterrence, credible commitments, incremental, verification-heavy policies.</p>
        </div>
        <div class="agent">
          <h4>Agent B — Humanitarian Diplomat</h4>
          <p class="sys">Human rights, corridors, confidence-building, inclusive governance, win-wins.</p>
        </div>
        <div class="agent">
          <h4>Agent C — Data-Driven Technocrat</h4>
          <p class="sys">Mechanism design, KPIs, pilots, incentive alignment, measurable outcomes.</p>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    // === Optional Public Feed Config (FREE via Supabase) =========================
    // 1) Create a Supabase project (free). Add a table "debates" with columns:
    //    id: uuid default uuid_generate_v4(), created_at: timestamptz default now(),
    //    question: text, summary: text
    // 2) Enable Row Level Security with a policy that allows anon insert/select for those columns.
    // 3) Paste your values below (or leave empty to use local-only feed).
    const PARLEY_SUPABASE_URL = "";        // e.g. "https://abcxyz.supabase.co"
    const PARLEY_SUPABASE_ANON_KEY = "";   // e.g. "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    // ============================================================================

    const statusEl=document.getElementById('status');
    const meterBar=document.getElementById('meterBar');
    const runBtn=document.getElementById('runBtn');
    const loadBtn=document.getElementById('loadBtn');
    const saveBtn=document.getElementById('saveBtn');
    const postXBtn=document.getElementById('postXBtn');
    const feedEl=document.getElementById('feed');

    const chatEl=document.getElementById('chat');
    const questionEl=document.getElementById('question');
    const turnsEl=document.getElementById('turns');
    const goalEl=document.getElementById('goal');
    const modelEl=document.getElementById('model');
    const wgpuBanner=document.getElementById('wgpuBanner');

    const aEl=document.getElementById('a') || { value:"You are a Realist Strategist..." };
    const bEl=document.getElementById('b') || { value:"You are a Humanitarian Diplomat..." };
    const cEl=document.getElementById('c') || { value:"You are a Data-Driven Technocrat..." };

    let engine=null;
    let lastQuestion="";
    let lastSummary="";

    // WebGPU warning
    if(!('gpu' in navigator)){ wgpuBanner.style.display='block'; }

    function setStatus(t){ statusEl.textContent=t; }
    function setProgress(p){ meterBar.style.width=`${Math.max(2,Math.floor(p*100))}%`; }

    function logBubble(role,text){
      const div=document.createElement('div');
      div.className=`bubble agent${role}`;
      div.textContent=text;
      chatEl.appendChild(div);
      chatEl.scrollTop=chatEl.scrollHeight;
    }

    async function loadModel(){
      setStatus('Importing WebLLM…');
      loadBtn.disabled=true;
      try{
        const webllm=await import('https://esm.run/@mlc-ai/web-llm');
        setStatus(`Loading model: ${modelEl.value}`);
        engine=await webllm.CreateMLCEngine(modelEl.value,{
          initProgressCallback:(p)=>{ setProgress(p.progress||0); setStatus(`Loading: ${Math.round((p.progress||0)*100)}% — ${p.text||''}`); }
        });
        runBtn.disabled=false;
        setStatus('Model ready.');
        setProgress(1);
      }catch(e){
        console.error(e);
        setStatus('Failed to load. Enable WebGPU (Chrome/Edge 113+).');
        loadBtn.disabled=false;
      }
    }

    async function generate(messages){
      const chunks=await engine.chat.completions.create({messages,stream:true,temperature:0.9});
      let reply='';
      for await(const ch of chunks){ reply += ch.choices?.[0]?.delta?.content || ''; }
      return reply.trim();
    }

    function buildPrompt(rolePrompt,userQ,goal){
      return [
        { role:'system', content:`${rolePrompt}\nGoal: ${goal}` },
        { role:'user', content:`Question: ${userQ}\nRespond concisely in 5–8 sentences.` }
      ];
    }
    function rebuttalPrompt(rolePrompt, transcript, goal){
      return [
        { role:'system', content:`${rolePrompt}\nGoal: ${goal}` },
        { role:'user', content:`Transcript so far:\n${transcript}\nWrite your next turn with specifics and a concrete proposal.` }
      ];
    }
    function synthPrompt(transcript){
      return [
        { role:'system', content:'You are the Moderator. Synthesize agreement/tension into a realistic plan.' },
        { role:'user', content:`Create a final outcome based on this debate:\n${transcript}\nOutput:\n1) Joint Plan: three concrete steps.\n2) Risks: two bullets + mitigations.\n3) Open Question: one unresolved issue.` }
      ];
    }

    async function runParley(){
      if(!engine) return alert('Load a model first.');
      chatEl.innerHTML='';
      saveBtn.disabled=true; postXBtn.disabled=true;

      const q=(questionEl.value||"").trim() || "How can rival blocs deescalate tensions while protecting small states' sovereignty and trade resilience?";
      const turns=Math.max(1, parseInt(turnsEl.value||'2',10));
      const goal=(goalEl.value||"").trim();

      const personas=[];
      if(aEl.value.trim()) personas.push(['A', aEl.value.trim()]);
      if(bEl.value.trim()) personas.push(['B', bEl.value.trim()]);
      if(cEl.value.trim()) personas.push(['C', cEl.value.trim()]);
      if(personas.length<2) return alert('Please keep at least two agents.');

      let transcript='';

      setStatus('Generating opening statements…');
      for(const [tag,prompt] of personas){
        const msg=await generate(buildPrompt(prompt,q,goal));
        transcript+=`\n\n[${tag}] ${msg}`;
        logBubble(tag,msg);
      }

      setStatus('Running debate…');
      for(let t=0; t<turns-1; t++){
        for(const [tag,prompt] of personas){
          const msg=await generate(rebuttalPrompt(prompt, transcript.slice(-4000), goal));
          transcript+=`\n\n[${tag}] ${msg}`;
          logBubble(tag,msg);
        }
      }

      setStatus('Synthesizing…');
      const mod=await generate(synthPrompt(transcript.slice(-6000)));
      logBubble('Moderator',mod);
      setStatus('Done.');

      // Prepare shareables
      lastQuestion=q;
      lastSummary=summarizeForSocial(mod);
      saveBtn.disabled=false;
      postXBtn.disabled=false;
    }

    function summarizeForSocial(text){
      // Very light squeeze for social sharing
      let t=(text||"").replace(/\s+/g,' ').trim();
      if(t.length>220) t=t.slice(0,217)+'…';
      return t;
    }

    // === Local Feed ==========================================================
    function loadLocalFeed(){
      try{ return JSON.parse(localStorage.getItem('parleyFeed')||'[]'); }
      catch{ return []; }
    }
    function saveLocalFeed(item){
      const arr=loadLocalFeed();
      arr.unshift(item);
      localStorage.setItem('parleyFeed', JSON.stringify(arr.slice(0,50)));
    }

    function renderFeed(items){
      feedEl.innerHTML='';
      if(!items.length){ feedEl.innerHTML = '<div class="tiny">No debates saved yet.</div>'; return; }
      for(const it of items){
        const card=document.createElement('div');
        card.className='feed-item';
        card.innerHTML = `<h5>${escapeHtml(it.question)}</h5>
          <div class="tiny" style="margin-bottom:6px">${new Date(it.created_at||Date.now()).toLocaleString()}</div>
          <small>${escapeHtml(it.summary||'')}</small>`;
        feedEl.appendChild(card);
      }
    }
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;' }[m]));}

    // === Optional Supabase public feed ======================================
    async function fetchPublicFeed(){
      if(!PARLEY_SUPABASE_URL || !PARLEY_SUPABASE_ANON_KEY) return [];
      try{
        const res=await fetch(`${PARLEY_SUPABASE_URL}/rest/v1/debates?select=question,summary,created_at&order=created_at.desc&limit=25`,{
          headers:{apikey:PARLEY_SUPABASE_ANON_KEY, Authorization:`Bearer ${PARLEY_SUPABASE_ANON_KEY}`}
        });
        if(!res.ok) throw new Error('feed fetch failed');
        return await res.json();
      }catch(e){ console.warn('Public feed fetch error:',e); return []; }
    }
    async function savePublic(item){
      if(!PARLEY_SUPABASE_URL || !PARLEY_SUPABASE_ANON_KEY) return false;
      try{
        const res=await fetch(`${PARLEY_SUPABASE_URL}/rest/v1/debates`,{
          method:'POST',
          headers:{'Content-Type':'application/json', apikey:PARLEY_SUPABASE_ANON_KEY, Authorization:`Bearer ${PARLEY_SUPABASE_ANON_KEY}`},
          body:JSON.stringify(item)
        });
        return res.ok;
      }catch(e){ console.warn('Public save error:',e); return false; }
    }

    async function refreshFeed(){
      const local=loadLocalFeed();
      const remote=await fetchPublicFeed();
      // Merge remote (if any) + local with newest first
      const merged=[...remote, ...local].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
      renderFeed(merged);
    }

    // === Share & Save actions ===============================================
    postXBtn.addEventListener('click', ()=>{
      if(!lastQuestion || !lastSummary) return;
      const text = `Q: ${lastQuestion}\n${lastSummary}\n#ParleyProtocol`;
      const url  = encodeURIComponent(text);
      window.open(`https://twitter.com/intent/tweet?text=${url}`, '_blank');
    });

    saveBtn.addEventListener('click', async ()=>{
      if(!lastQuestion || !lastSummary) return;
      const item={question:lastQuestion, summary:lastSummary, created_at:new Date().toISOString()};
      saveLocalFeed(item);
      await savePublic(item); // harmless if not configured
      await refreshFeed();
      setStatus('Saved to feed.');
    });

    // Boot
    (async ()=>{ await refreshFeed(); })();

    // Listeners
    loadBtn.addEventListener('click',loadModel);
    runBtn.addEventListener('click',runParley);
  </script>
</body>
</html>
